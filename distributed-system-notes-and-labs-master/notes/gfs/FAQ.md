## GFS FAQ

Q： 为什么原子记录至少追加一次，而不是恰好一次？

A：第3.1节第7步说，如果在其中一个secondaries上写入失败，客户机将重新尝试写入。这将导致在未失败的副本上多次追加数据。不同的设计可能会检测到重复的客户端请求，尽管任意失败（例如原始请求和客户端重试之间的主要故障）。你将在lab3中实现这样的设计，在复杂性和性能方面需要付出相当大的代价。

***

Q： 应用程序如何知道块的哪些部分由填充和重复记录组成？

A： 为了检测填充，应用程序可以在有效记录的开头放一个可预测的magic number，或者包含一个只有在记录有效时才有效的校验和。应用程序可以通过在记录中包含唯一的id来检测重复项。然后，如果它读取的记录与以前的记录具有相同的ID，它就知道它们是彼此重复的。GFS为处理这些情况的应用程序提供了一个库。

***

Q： 如果原子记录append在文件中以不可预知的偏移量写入数据，客户机如何找到它们的数据？

A： Append（和一般的GFS）主要用于顺序读取整个文件的应用程序。这样的应用程序将扫描文件以寻找有效的记录（见上一个问题），因此他们不需要事先知道记录的位置。例如，该文件可能包含一组并发web爬虫程序遇到的一组链接url。任何给定URL的文件偏移量都无关紧要；读者只希望能够读取整个URL集。

***

Q： 什么是 校验和checksum?

A： 校验和算法将一个字节块作为输入，并返回单个数字。例如，一个简单的校验和可以是输入中所有字节的总和（mod some big number）。GFS存储每个块以及块的校验和。当chunkserver在其磁盘上写入一个块时，它首先计算新块的校验和，并将校验和保存在磁盘上。当chunkserver从磁盘读取块时，它还会读取先前保存的校验和，从磁盘读取的块中重新计算校验和，并检查两个校验和是否匹配。如果数据被磁盘损坏，校验和将不匹配，chunkserver将知道返回一个错误。另外，一些GFS应用程序将它们自己的校验和存储在GFS文件中的应用程序定义的记录之上，以区分正确的记录和填充。CRC32是校验和算法的一个例子。

***

Q：这篇文章提到了引用计数——它们是什么？

A： 它们是快照“写时拷贝”实现的一部分。当GFS创建快照时，它不复制块，而是增加每个块的引用计数器。这使得创建快照的成本很低。如果客户机写入一个块，并且主机注意到引用计数大于1，则主机首先生成一个副本，以便客户机可以更新该副本（而不是快照的一部分）的块。你可以将此视为将复制延迟到绝对必要为止。希望不是所有的块都会被修改，人们可以避免做一些复制。

***

Q： 如果应用程序使用标准的POSIX文件api，是否需要修改它才能使用GFS？

A： 是的，但GFS不适用于现有的应用程序。它是为新编写的应用程序而设计的，例如MapReduce程序。

***

Q： GFS如何确定最近副本的位置？

A： 本文暗示GFS是基于存储可用副本的服务器的IP地址来实现这一点的。在2003年，谷歌必须以这样一种方式分配IP地址：如果两个IP地址在IP地址空间中彼此接近，那么它们在机房中也会很接近。

***

Q： 假设S1是块的主节点，主节点和S1之间的网络发生故障。主服务器会注意到并指定其他一些服务器作为主服务器，比如S2。然而S1实际上并没有失败，那么现在同一块有两个主节点吗？

A： 这将是一场灾难，因为两个主服务器可能会对同一个块应用不同的更新。幸运的是，GFS的租赁机制阻止了这种情况。第二个主租约被授予第二个主租约S1。S1知道在租约到期时不再是主服务器。主服务器不会向S2授予租约，直到之前对S1的租约到期。所以S2在S1停止后才会开始充当主节点。

***

Q： 对于块大小来说，64兆字节听起来太大了！

A： 64MB块大小是主机中的记帐单位，也是在chunkserver上对文件进行分片的粒度。客户机可以发出更小的读写操作——它们不必处理整个64MB的块。使用如此大的块大小的目的是为了减少主数据表中的元数据表的大小，并避免限制希望进行大量传输的客户端以减少开销。另一方面，小于64MB的文件并不能获得太多的并行性。

***

Q： 谷歌还使用GFS吗？

A： 有传言说GFS已经被一种叫做Colossus的东西取代了，它有着相同的总体目标，但在主控性能和容错能力方面有所改进。

***

Q： GFS用正确性换取性能和简单性的做法有多令人接受？

A： 这是分布式系统中经常出现的主题。强一致性通常需要复杂的协议，并且需要机器之间的聊天（我们将在接下来的几节课中看到）。通过利用特定应用程序类能够容忍宽松一致性的方法，可以设计出具有良好性能和足够一致性的系统。例如，GFS针对MapReduce应用程序进行了优化，这些应用程序需要大文件的高读取性能，并且可以处理文件中存在漏洞、记录多次显示以及读取不一致的问题。另一方面，GFS不适合在银行存储账户余额

***

Q： 如果master失败了怎么办？

A： 有复制master状态的完整副本；论文的设计需要人为干预，以便在主控失败后切换到其中一个副本（第5.1.3节）。稍后我们将看到如何使用Raft构建复制服务，并自动切换到备份。

***

Q：单master是个好主意吗？

A： 这一想法简化了最初的部署，但从长远来看并不是很好。这篇文章——https://queue.acm.org/detail.cfm?id=1594206——说随着时间的推移和GFS使用的增长，有些事情出了问题。文件的数量增长到足以将所有文件的元数据存储在单个主机的RAM中是不合理的。客户机的数量增长到一个主服务器没有足够的CPU能力来为它们服务。从发生故障的主机切换到备份需要人工干预这一事实使恢复速度变慢。显然，谷歌用Colossus取代了GFS，将主机拆分到多个服务器上，并实现了更自动化的主机故障恢复。